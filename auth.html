<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Connexion / Inscription</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.3/dist/umd/supabase.min.js"></script>
  <style>
    body {
      background-color: #222;
      color: #fff6dd;
      font-family: 'Arial', sans-serif;
      text-align: center;
      padding: 50px;
    }
    h1 {
      font-size: 2.2rem;
      margin-bottom: 30px;
    }
    input {
      padding: 10px;
      font-size: 1rem;
      margin: 10px;
      border-radius: 8px;
      border: none;
      width: 250px;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      margin: 10px;
      background-color: #5c3b1e;
      color: #fff6dd;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #704c2b;
    }
    #status {
      margin-top: 20px;
      font-size: 1.1rem;
      color: #ffccaa;
    }
  </style>
</head>
<body>
  <h1>Connexion au Royaume </h1><br>
    <h4>Si tu veux tester tous les niveaux connecte toi avec :</h4>
    <h4>Email : pablopierre0601@gmail.com</h4>
    <h4>Mot de passe: pablito </h4> 
</h1>

  <input type="email" id="email" placeholder="Email" required><br>
  <input type="password" id="password" placeholder="Mot de passe" required><br>

  <button onclick="signIn()">Se connecter</button>
  <button onclick="signUp()">S’inscrire</button>

  <div id="status"></div>

  <script>
    const supabase = window.supabase.createClient(
      "https://rajtrxypmoskqeoylgmd.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhanRyeHlwbW9za3Flb3lsZ21kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NjE5MDUsImV4cCI6MjA3MDAzNzkwNX0.RcGUqd0BGdGS-iIcChwwkVmg25y3hKvmm0by_HmvTZw"
    );

    async function signUp() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      const { data, error } = await supabase.auth.signUp({ email, password });

      if (error) {
        document.getElementById('status').textContent = "Erreur inscription : " + error.message;
        return;
      }

      document.getElementById('status').textContent = "Inscription réussie ! Connexion...";
      setTimeout(() => signIn(), 1500);
    }

    async function signIn() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      const { data: sessionData, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        document.getElementById('status').textContent = "Erreur connexion : " + error.message;
        return;
      }

      const { data: userData } = await supabase.auth.getUser();
      const userId = userData?.user?.id;

      if (!userId) {
        document.getElementById('status').textContent = "Erreur : utilisateur introuvable.";
        return;
      }

      await handleLogin(userId, password);
    }

    async function handleLogin(userId, password) {
      localStorage.setItem('user_id', userId);
      const { data, error } = await supabase
        .from('progressions')
        .select('level')
        .eq('user_id', userId)
        .single();

      if (error || !data) {
        // Nouvelle entrée progression
        const { error: insertError } = await supabase
          .from('progressions')
          .insert([
            {
              user_id: userId,
              level: 1,
              pass : password
            }
          ]);

        if (insertError) {
          document.getElementById('status').textContent = "Erreur progression : " + insertError.message;
          return;
        }

        localStorage.setItem('currentLevel', 1);
      } else {
        localStorage.setItem('currentLevel', data.level);
      }

      // Rediriger
      window.location.href = "home_page.html";
    }
  </script>
</body>
</html>
